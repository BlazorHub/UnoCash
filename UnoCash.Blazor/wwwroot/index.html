<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>UnoCash</title>
    <base href="/" />
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="css/site.css" rel="stylesheet" />
    <link href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQEAYAAABPYyMiAAAABmJLR0T///////8JWPfcAAAACXBIWXMAAABIAAAASABGyWs+AAAAF0lEQVRIx2NgGAWjYBSMglEwCkbBSAcACBAAAeaR9cIAAAAASUVORK5CYII=" rel="icon" type="image/x-icon" />
</head>
<body>
    <app>Loading...</app>

    <script src="_framework/blazor.webassembly.js"></script>
    <script src="scripts/azure-storage.blob.min.js"></script>

<script>
        function uploadToBlobStorage() {
            var file = document.querySelector('input[type=file]').files[0];

            // Get SAS token from Azure Function
            const token = '?st=2019-07-13T10%3A01%3A33Z&se=2026-07-14T10%3A01%3A00Z&sp=racwdl&sv=2018-03-28&sr=c&sig=F1jpNFt4H0ujsGqCaeIZiwWwKXEAV7YE4WPxhkvcd4A%3D';

            const blobUri = 'http://127.0.0.1:10000/devstoreaccount1';
            const blobService = AzureStorage.Blob.createBlobServiceWithSas(blobUri, token);

            blobService.createBlockBlobFromBrowserFile(
                'receipts', 
                file.name, 
                file, 
                (error, _) => {
                    if(error) {
                        // Handle blob error
                    } else {
                        // Now invoke Function to run analysis and get results
                        var xmlHttp = new XMLHttpRequest();
                        xmlHttp.responseType = 'json';
                        xmlHttp.onreadystatechange = function() { 
                            if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                                var j = xmlHttp.response;
                                var i = function (id) {
                                    return document.querySelector('input[id=' + id + ']');
                                };
                                console.log(JSON.stringify(j));
                                var date = new Date(j['date']);
                                console.log(j['date']);
                                // Then apply to the inputs
                                i('Payee').value = j['payee'];
                                i('Date').value = date.getFullYear() + '-' + ("0" + (date.getMonth() + 1)).slice(-2) + '-' + ("0" + date.getDate()).slice(-2);
                                //i('Account').value = j['method'];
                                i('Amount').value = j['amount'];
                            }
                        }
                        xmlHttp.open("GET", 'http://localhost:7071/api/GetReceiptData?blobName=' + file.name, true);
                        xmlHttp.send(null);
                    }
                });
        }
    </script>

</body>
</html>
